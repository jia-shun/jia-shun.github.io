


<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>  基于SpringBoot、STOMP使用WebSocket实现聊天室功能 |    freedom</title>
  <meta name="description" content="free soul">
  <!-- 标签页图标 -->
  

  <!-- 图标库 -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css" rel="stylesheet">
  <!-- 动画库 -->
  
  <!-- css文件 -->
  <link rel="stylesheet" href="/css/white.css">
  <!-- 代码高亮 -->
  
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.1.1/styles/github.css">
    
  
</head>
</html>

<body>

<div class="menu-outer">
    <div class="menu-inner">
      <div class="menu-site-name  ">
        <a href="/">
          freedom
        </a>
        
      </div>
      <div class="menu-group">
        <ul class="menu-ul">
        
          <a href="/" class="nav-link">
            <li class="menu-li  ">
              HOME
            </li>
          </a>
        
          <a href="/archives" class="nav-link">
            <li class="menu-li  ">
              BLOG
            </li>
          </a>
        
        
          <li class="menu-li " id="sort">
             CATEGORY
             <div class="categories-outer " id="sort-div">
               <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/音乐/">音乐</a></li></ul>
             </div>
          </li>
        
        
          <li class="menu-li " id="mobile-menu">
            <i class="ri-menu-line"></i>
          </li>
        
        </ul>

      </div>

    </div>
</div>
<div id="mobile-main" class="">
  <div class="mobile-menu-inner">
    <div class="mobile-menu-site-name ">
      <a href="/">
        freedom
      </a>
    </div>
    <div class="mobile-menu-group" id="mobile-close">
      <i class="ri-close-line"></i>
    </div>

  </div>

  <div class="mobile-menu-div">
  
    <a href="/" class="mobile-nav-link">
      <div class="mobile-menu-child ">
        <span>HOME</span>
      </div>
    </a>
  
    <a href="/archives" class="mobile-nav-link">
      <div class="mobile-menu-child ">
        <span>BLOG</span>
      </div>
    </a>
  
  
  </div>


</div>

<div class="body-outer">
  <div class="body-inner">
    
<article class="post-inner">
  <div class="post-content-outer">
    <div class="post-intro">
      <div class="post-title animate__animated  animate__fadeInUp">基于SpringBoot、STOMP使用WebSocket实现聊天室功能</div>
      <div class="meta-intro animate__animated  animate__fadeInUp">11月 16 2017</div>
      
    </div>
    <div class="post-content-inner">
      <div class="post-content-inner-space">

      </div>
      <div class="post-content-main animate__animated  animate__fadeInUp">
        <!-- top型目录 -->
        
        <h2 id="WebSocket："><a href="#WebSocket：" class="headerlink" title="WebSocket："></a>WebSocket：</h2><p>新项目中有一个模块需求使用到了WebSocket，因为之前没用过，所以做了一些研究。</p>
<p>关于WebSocket，简单说两句：最初前端与后端交互都是基于Http协议，前端发送request，后端返回response。存在的问题就是：response永远是被动的，不能主动发起。如果要想保持与后端的长连接，最初的实现方式基本都是ajax轮询或者http long poll。这两种方式都需要占用很多的资源，并且Http还是一个无状态协议。而WebSocket是HTML5出的东西，通俗点就是可以实现前端只发送一次请求，后端就可以与前端保持长连接，并实时的传输数据。最直白的例子就是聊天系统的实现，点对点两个人聊天，你一句我一句。也可以群嗨，一大群人叽叽歪歪，这样每个人对于其他人来说可以理解为一个广播系统，其他人可以理解为自己的订阅者。</p>
<p>项目中基于SpringBoot和STOMP，其中的逻辑相对复杂，这儿仅写一个简单的Demo：实现点对点聊天功能。话不多说，直接开搞。</p>
<h3 id="代码中的具体解释看注释，都描述的很清楚。"><a href="#代码中的具体解释看注释，都描述的很清楚。" class="headerlink" title="代码中的具体解释看注释，都描述的很清楚。"></a>代码中的具体解释看注释，都描述的很清楚。</h3><p>首先了解下STOMP：<br>Stomp是一种简单（流）文本定向消息协议，提供了一个可互操作的链接格式。允许stomp客户端与任意stomp消息代理（Broker）进行交互。</p>
<h2 id="一：新建一个SpringBoot项目，选择Security、Thymeleaf和WebSocket依赖。"><a href="#一：新建一个SpringBoot项目，选择Security、Thymeleaf和WebSocket依赖。" class="headerlink" title="一：新建一个SpringBoot项目，选择Security、Thymeleaf和WebSocket依赖。"></a>一：新建一个SpringBoot项目，选择Security、Thymeleaf和WebSocket依赖。</h2><p>
        <span class="lazyload-img-span">
        <img data-src="https://blog-1257890402.cos.ap-beijing.myqcloud.com/websocket/WechatIMG45.jpeg">
        
      </span></p>
<h2 id="二：Spring-Security的简单配置"><a href="#二：Spring-Security的简单配置" class="headerlink" title="二：Spring Security的简单配置"></a>二：Spring Security的简单配置</h2><p>本例只是实现了一个简单的聊天室程序。例子中有两个用户，互相发送消息给彼此，所以我们在这里我们先对Spring Security做一些简单的配置。对于Spring Security这里不做特别多的解释，Spring Security是专门针对基于Spring的项目安全框架，和Shiro一样可以实现程序的认证和权限控制。</p>
<p>这里主要是分配两个用户，名字为“Michael”和“Janet”，密码都是“freedom”。</p>
<pre><code class="java">package cn.js.websocket.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.builders.WebSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    protected void configure(HttpSecurity httpSecurity) throws Exception {
        httpSecurity
        .authorizeRequests()
        .antMatchers(&quot;/&quot;,&quot;/login&quot;)//设置Spring Security对/和/&quot;login&quot;路径不拦截
        .permitAll()
        .anyRequest()
        .authenticated()
        .and()
        .formLogin()
        .loginPage(&quot;/login&quot;)//设置SpringSecurity的登录页面为/login
        .defaultSuccessUrl(&quot;/chat&quot;)//登录成功后转向/chat路径
        .permitAll()
        .and()
        .logout()
        .permitAll();
        }
    //在内存中分配两个用户Michael和Janet，密码都为freedom，角色都是USER
    protected void configure(AuthenticationManagerBuilder authenticationManagerBuilder) throws Exception {
        authenticationManagerBuilder
        .inMemoryAuthentication()
        .withUser(&quot;Michael&quot;).password(&quot;freedom&quot;).roles(&quot;USER&quot;)
        .and()
        .withUser(&quot;Janet&quot;).password(&quot;freedom&quot;).roles(&quot;USER&quot;);
        }
    // /resources/static/目录下的静态资源，Spring Security不拦截
    public void configure(WebSecurity webSecurity)throws Exception{
        webSecurity.ignoring().antMatchers(&quot;/resources/static/**&quot;);
    }

}
</code></pre>
<h2 id="三：配置WebSocket"><a href="#三：配置WebSocket" class="headerlink" title="三：配置WebSocket"></a>三：配置WebSocket</h2><pre><code class="java">
package cn.js.websocket.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.AbstractWebSocketMessageBrokerConfigurer;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
@Configuration
//此注解表示开启WebSocket支持。通过此注解开启使用STOMP协议来传输基于代理（message broker）的消息。
@EnableWebSocketMessageBroker
public class WebSocketConfig extends AbstractWebSocketMessageBrokerConfigurer {
    @Override
    public void registerStompEndpoints(StompEndpointRegistry stompEndpointRegistry) {
        //注册一个名为/endpointChat的节点，并指定使用SockJS协议。
        stompEndpointRegistry.addEndpoint(&quot;/endpointChat&quot;).withSockJS();
    }
    //配置消息代理（Message Broker），可以理解为信息传输的通道
    public void configureMessageBroker(MessageBrokerRegistry messageBrokerRegistry) {
        //点对点式应增加一个/queue的消息代理。相应的如果是广播室模式可以设置为&quot;/topic&quot;
           messageBrokerRegistry.enableSimpleBroker(&quot;/queue&quot;);
    }
}
</code></pre>
<h2 id="四：编写控制器"><a href="#四：编写控制器" class="headerlink" title="四：编写控制器"></a>四：编写控制器</h2><pre><code class="java">package cn.js.websocket.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import java.security.Principal;

@Controller
public class WebSocketController {
    @Autowired
    //通过SimpMessagingTemplate模板向浏览器发送消息。如果是广播模式，可以直接使用注解@SendTo
    private SimpMessagingTemplate simpMessagingTemplate;

    //开启STOMP协议来传输基于代理的消息，这时控制器支持使用@MessageController，就像使用@RequestMapping       是一样的
    //当浏览器向服务端发送请求时，通过@MessageController映射/chat这个路径
    @MessageMapping(&quot;/chat&quot;)
    //在SpringMVC中，可以直接在参数中获得principal,其中包含当前用户的信息
    public void handleChat(Principal principal,String msg) {
        //下面的代码就是如果发送人是Michael，接收人就是Janet，发送的信息是message，反之亦然。
        if(principal.getName().equals(&quot;Michael&quot;)){
        //通过SimpMessagingTemplate的convertAndSendToUser向用户发送消息。
        //第一参数表示接收信息的用户，第二个是浏览器订阅的地址，第三个是消息本身
        simpMessagingTemplate.convertAndSendToUser(&quot;Janet&quot;,&quot;/queue/notifications&quot;,
        principal.getName() + &quot;-发送:&quot; + msg);
        } else {
        simpMessagingTemplate.convertAndSendToUser(&quot;Michael&quot;,&quot;/queue/notifications&quot;,
        principal.getName() + &quot;-发送:&quot; + msg);
        }
    }
}</code></pre>
<h2 id="五：添加脚本"><a href="#五：添加脚本" class="headerlink" title="五：添加脚本"></a>五：添加脚本</h2><p>将sockjs.min.js（SockJS的客户端脚本）、stomp.js（STOMP协议的客户端脚本）、jquery-3.1.1.js（jQuery）放置在src/main/resources/static下，（可在文末GitHub中Clone项目得到三个文件）</p>
<h2 id="六：编写登录和聊天室页面"><a href="#六：编写登录和聊天室页面" class="headerlink" title="六：编写登录和聊天室页面"></a>六：编写登录和聊天室页面</h2><p>因为此Demo基于Thymeleaf，所以在src/main/resources/templates下新建一个最简单的login.html页面，代码如下：</p>
<pre><code class="html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;title&gt;聊天室登录页面&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div th:if=&quot;${param.error}&quot;&gt;
无效的账号和密码
&lt;/div&gt;
&lt;div th:if=&quot;${param.logout}&quot;&gt;
您已注销
&lt;/div&gt;
&lt;form th:action=&quot;@{/login}&quot; method=&quot;post&quot;&gt;
&lt;div&gt;&lt;label&gt;账号：&lt;input type=&quot;text&quot; name=&quot;username&quot;/&gt;&lt;/label&gt;&lt;/div&gt;
&lt;div&gt;&lt;label&gt;密码：&lt;input type=&quot;password&quot; name=&quot;password&quot;/&gt;&lt;/label&gt;&lt;/div&gt;
&lt;div&gt;&lt;input type=&quot;submit&quot; value=&quot;登录&quot;/&gt;&lt;/div&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>在src/main/resources/templates下新建chat.html页面，代码如下：</p>
<pre><code class="html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot; /&gt;
&lt;title&gt;聊天页面&lt;/title&gt;
&lt;script th:src=&quot;@{sockjs.min.js}&quot;&gt;&lt;/script&gt;
&lt;script th:src=&quot;@{stomp.js}&quot;&gt;&lt;/script&gt;
&lt;script th:src=&quot;@{jquery-3.1.1.js}&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;p&gt;
聊天室
&lt;/p&gt;

&lt;form id=&quot;JanetForm&quot;&gt;
&lt;textarea rows=&quot;4&quot; cols=&quot;60&quot; name=&quot;text&quot;&gt;&lt;/textarea&gt;
&lt;input type=&quot;submit&quot;/&gt;
&lt;/form&gt;

&lt;script th:inline=&quot;javascript&quot;&gt;
$(&#39;#JanetForm&#39;).submit(function (e) {
e.preventDefault();
var text = $(&#39;#JanetForm&#39;).find(&#39;textarea[name=&quot;text&quot;]&#39;).val();
sendSpittle(text);
});
//    连接endpoint为&quot;/endpointChat&quot;的节点
var sock = new SockJS(&quot;/endpointChat&quot;);
var stomp = Stomp.over(sock);
//    连接WebSocket服务端
stomp.connect(&#39;guest&#39;,&#39;guest&#39;,function (frame) {
//        订阅/user/queue/notifications发送的消息，这里与在控制器的messagingTemplate.convertAndSendToUser中定义的订阅地址保持一致。
//        这里多了一个/user，并且这个user是必须的，使用了/user才会发送消息到指定的用户
stomp.subscribe(&quot;/user/queue/notifications&quot;,handleNotification);
});
function handleNotification(message) {
$(&#39;#output&#39;).append(&quot;&lt;b&gt;收到了:&quot; + message.body + &quot;&lt;/b&gt;&lt;br/&gt;&quot;)
}
function sendSpittle(text) {
//        表示向后端路径/chat发送消息请求，这个是在控制器中@MessageMapping中定义的。
stomp.send(&quot;/chat&quot;,{},text);
}
$(&#39;#stop&#39;).click(function () {
{sock.close()}
});
&lt;/script&gt;
&lt;div id=&quot;output&quot;&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h2 id="七：增加页面的viewController，指定页面的跳转"><a href="#七：增加页面的viewController，指定页面的跳转" class="headerlink" title="七：增加页面的viewController，指定页面的跳转"></a>七：增加页面的viewController，指定页面的跳转</h2><pre><code class="java">package cn.js.websocket.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ViewControllerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;

@Configuration
public class WebMvcConfig extends WebMvcConfigurerAdapter{
    public void addViewControllers(ViewControllerRegistry viewControllerRegistry) {
        viewControllerRegistry.addViewController(&quot;/login&quot;).setViewName(&quot;/login&quot;);
        viewControllerRegistry.addViewController(&quot;/chat&quot;).setViewName(&quot;/chat&quot;);
    }
}</code></pre>
<h2 id="八：测试"><a href="#八：测试" class="headerlink" title="八：测试"></a>八：测试</h2><p>这样我们开两个浏览器窗口，地址为localhost:8080/login,分别用Michael和Janet两个用户登录，就可以互相发送消息聊天了。</p>
<p>
        <span class="lazyload-img-span">
        <img data-src="https://blog-1257890402.cos.ap-beijing.myqcloud.com/websocket/WechatIMG48.jpeg">
        
      </span></p>
<p>
        <span class="lazyload-img-span">
        <img data-src="https://blog-1257890402.cos.ap-beijing.myqcloud.com/websocket/WechatIMG50.jpeg">
        
      </span></p>
<p>项目Github地址：<a href="https://github.com/jia-shun/websocket" target="_blank" rel="noopener">https://github.com/jia-shun/websocket</a></p>
<p>欢迎关注我的GitHub。</p>
<p>参考资料：Java EE开发的颠覆者：SpringBoot 实战</p>
<p>
        <span class="lazyload-img-span">
        <img data-src="https://blog-1257890402.cos.ap-beijing.myqcloud.com/code-ready.jpg">
        
      </span></p>
<center>快掏出你的大手机扫我</center>

        <!-- 分类文章 -->
        
          <div class="post-categoris-bottom">
            <div class="post-categoris-name">技术</div>
            <ul>
            
            
              
            
            
            
              
                <li class="me base">
                  <a  href="/2017/11/16/基于SpringBoot、STOMP使用WebSocket实现聊天室功能/" class="post-categoris-bottom-link">
                  基于SpringBoot、STOMP使用WebSocket实现聊天室功能
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2018/04/30/JWT/" class="post-categoris-bottom-link">
                  JSON Web Token
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2018/07/14/TiDB-重新定义下一代关系型数据库/" class="post-categoris-bottom-link">
                  TiDB:重新定义下一代关系型数据库
                </a>
                </li>
              
              
            
            
            
              
            
            
            
              
                <li class="base">
                  <a  href="/2018/08/12/gRPC/" class="post-categoris-bottom-link">
                  gRPC基于Golang和Java的简单实现
                </a>
                </li>
              
              
            
            
            
              
            
            
            
              
            
            
            
              
                <li class="base">
                  <a  href="/2019/08/20/关于RabbitMQ，看这篇文章就够了/" class="post-categoris-bottom-link">
                  关于RabbitMQ，看这篇文章就够了
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2019/10/15/JVM/" class="post-categoris-bottom-link">
                  JVM
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2019/11/30/ThreadLocal/" class="post-categoris-bottom-link">
                  ThreadLocal
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2019/12/15/Synchronized/" class="post-categoris-bottom-link">
                  Synchronized关键字
                </a>
                </li>
              
              
            
            
            
              
            
            
            
              
                <li class="base">
                  <a  href="/2021/03/22/管理小记/" class="post-categoris-bottom-link">
                  管理小记
                </a>
                </li>
              
              
            
            
            
              
            
            
            
              
                <li class="base">
                  <a  href="/2021/05/05/架构笔记/" class="post-categoris-bottom-link">
                  架构笔记
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2021/08/20/Spring Data JPA/" class="post-categoris-bottom-link">
                  Spring Data JPA
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2021/08/20/Redisson/" class="post-categoris-bottom-link">
                  Redisson
                </a>
                </li>
              
              
            
            
            
              
                <li class="base">
                  <a  href="/2021/08/21/Java单元测试/" class="post-categoris-bottom-link">
                  Java Unit Test
                </a>
                </li>
              
              
            
            
            </ul>

          </div>

        
      </div>
      <div class="post-content-inner-space">
        
      </div>
   </div>
    <!-- 评论 -->
    
  </div>
</article>
  </div>
</div>



<!-- 如果是home模式的话，不在首页就显示footer，如果不是home模式的话 所有都显示footer -->

  <div class="footer-outer animate__animated  animate__fadeInUp">
    <div class="footer-inner">
    <div class="footer-text">
    <p>everything will flow</p>

    </div>
    <div class="footer-contact">
    <ul class="footer-ul">
        
        <li class="footer-li">
            <a href="https://github.com/jia-shun" target="_blank">
                <i class="ri-github-line"></i>
            </a>
        </li>
        
        <li class="footer-li">
            <a href="mailto:jiashun@outlook.com" target="_blank">
                <i class="ri-mail-line"></i>
            </a>
        </li>
        
        <li class="footer-li">
            <a href="https://weibo.com/jiashunfreedom" target="_blank">
                <i class="ri-weibo-line"></i>
            </a>
        </li>
        
    </ul>
    </div>
    </div>
</div>





<script src="/js/white.js"></script>


    
      <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.1/build/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script>
    

</body>
</html>
