<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Java Unit Test | Freedom</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java Unit Test</h1><a id="logo" href="/.">Freedom</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java Unit Test</h1><div class="post-meta">2021-08-21<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span></div><div class="post-content"><p><img src="https://blog-1257890402.cos.ap-beijing.myqcloud.com/unit-test/unit-test.jpeg" alt="unit-test"></p>
<h3 id="WHAT"><a href="#WHAT" class="headerlink" title="WHAT"></a>WHAT</h3><blockquote>
<p>在计算机编程中，单元测试是一种软件测试方法，通过该方法对源代码的各个单元（一个或多个计算机程序模块的集合以及相关的控制数据、使用过程和操作过程）进行测试以确定它们是否符合使用要求。 —— 维基百科《Unit testing》</p>
<p>一个单元测试是一段自动化的代码，这段代码调用被测试的工作单元，之后对这个单元的单个最终结果的某些假设进行检验。单元测试几乎都是用单元测试框架编写的。单元测试容易编写，能快速运行。单元测试可靠、可读，并且可维护。只要产品代码不发生变化，单元测试的结果是稳定的。 —— Roy Osherove《单元测试的艺术》</p>
</blockquote>
<p>首先定义什么是单元？</p>
<p>我们一直认为单元指的是一个方法(函数)，甚者是所谓的单元越小越好。</p>
<p>但实践中会发现可测试的、需要测试的点单纯一个函数不能解决问题。</p>
<p>很多时候需要几个方法的联合调用关系达到测试的目的。你可以说程序员只关注单元测试就可以了，增量测试、集成测试、回归测试、冒烟测试等等是专门测试人员做的工作。而实际情况是很多时候我们在写测试用例的时候可以将这些串起来的点覆盖起来的。</p>
<p><strong>个人偏向于单元测试测试的粒度多大多小完全取决于你对需求的认知，将需求拆分的程度。而单元测试是和需求拆分程度映射的。而需求拆分的粒度就是一个测试单元。</strong></p>
<h3 id="WHY"><a href="#WHY" class="headerlink" title="WHY"></a>WHY</h3><p>很多时候我们不写单元测试的原因无非就两种情况：</p>
<ul>
<li><strong>懒得写：</strong> 一般写单测的时间会超过开发的时间，并且收益不明显，何况有测试人员在后面保证呢！</li>
<li><strong>不用写：</strong> 这点简单的代码逻辑还用写单元测试？</li>
</ul>
<p><img src="https://blog-1257890402.cos.ap-beijing.myqcloud.com/unit-test/system.jpg" alt="system"></p>
<p>图1是我亲身经历的一个系统，到最后写bug的速度已经超过了改bug的速度。当然造成这种情况的原因有很多，我们不讨论。但当我们准备重构的时候，发现没有任何保证，整个项目基本没有单元测试或者很少的单元测试。如果有单元测试我们重构起来会简单很多，或者说造成现在的局面没有单元测试是不是原因之一？</p>
<p><img src="https://blog-1257890402.cos.ap-beijing.myqcloud.com/unit-test/tdd.jpeg" alt="tdd"></p>
<p>以上摘自Bob大叔的《架构整洁之道》。</p>
<p>采用了TDD方法编程后不仅仅是代码质量的提升，长远看我们的效率是成上升趋势的。而一个快速迭代的项目一般开发效率是下降趋势的，甚至是最后沦为图1的”乱麻系统“。</p>
<p>而<code>懒得写</code>和<code>不用写</code>的情况都是短期现象，除了上面的两个例子，其实已经有大量的实践验证单元测试的必要性。我们应该看重长期效益。慢即是快这么简单的道理要坚信它是合理的。除非你的出发点就是做一个一锤子买卖的系统。</p>
<p>我们虽然不强制使用TDD的开发方式，但会开始尝试。</p>
<h3 id="HOW"><a href="#HOW" class="headerlink" title="HOW"></a>HOW</h3><p><strong>需求</strong></p>
<blockquote>
<p>我们的系统是网站之家。</p>
<p>本次需求是实现一个添加网站的接口，参数中包含网站名字和URI。</p>
<p>确保URI是有效的。</p>
</blockquote>
<p><strong>分析</strong></p>
<ul>
<li>需要一个方法判断URI是否有效</li>
<li>需要实现一个add接口</li>
</ul>
<p>依据需求我们先来写测试用例：</p>
<h4 id="Junit"><a href="#Junit" class="headerlink" title="Junit"></a>Junit</h4><p><strong>一：判断URI是否有效</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">linkableTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String linkableUri = <span class="string">"https://www.baidu.com/"</span>;</span><br><span class="line">    String unLinkableUri = <span class="string">"https://www.abcd123456789.com/"</span>;</span><br><span class="line">    Boolean linkable = UrlUtils.linkable(linkableUri);</span><br><span class="line">    Boolean unLinkable = UrlUtils.linkable(unLinkableUri);</span><br><span class="line">    assertEquals(linkable, Boolean.TRUE);</span><br><span class="line">    assertEquals(unLinkable, Boolean.FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上我们基于<code>Junit</code>使用断言实现了一个非常简单的测试用例。</p>
<p>根据测试用例我们建立UrlUtils类并实现一个linkable方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title">linkable</span><span class="params">(String uri)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO ...</span></span><br><span class="line">        <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>二：实现一个add接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTests</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    WebSiteDTO dto = WebSiteDTO.builder()</span><br><span class="line">            .name(<span class="string">"baidu"</span>)</span><br><span class="line">            .uri(<span class="string">"https://www.baidu.com/"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    Long id = webSiteService.add(dto);</span><br><span class="line">    assertNotNull(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后我们实现webSiteService的add方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WebSiteRepository webSiteRepository;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebSiteServiceImpl</span><span class="params">(WebSiteRepository webSiteRepository)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.webSiteRepository = webSiteRepository;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Long <span class="title">add</span><span class="params">(WebSiteDTO dto)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//TODO</span></span><br><span class="line">    <span class="keyword">return</span> webSiteRepository.add(dto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Mockito"><a href="#Mockito" class="headerlink" title="Mockito"></a>Mockito</h4><p>以上的测试有一个问题在于执行add方法的时候会操作数据库，而在真实环境中我们不希望测试数据会写入数据库造成脏数据或者本身不想依赖数据库去跑测试用例。此时我们可以使用<code>Mockito</code>框架实现数据Mock。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MockBean</span></span><br><span class="line"><span class="keyword">private</span> WebSiteRepository webSiteRepository;</span><br><span class="line">		</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMockTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    WebSiteDTO dto = WebSiteDTO.builder()</span><br><span class="line">            .name(<span class="string">"baidu"</span>)</span><br><span class="line">            .uri(<span class="string">"https://www.baidu.com/"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    Mockito.when(webSiteRepository.add(dto)).thenReturn(<span class="number">1L</span>);</span><br><span class="line">    Long id = webSiteService.add(dto);</span><br><span class="line">    assertNotNull(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上，我们基于<code>Mockito</code>的注解<code>@MockBean</code>和<code>when(….).thenReturn(….)</code>很简单的实现了webSiteRepository的打桩测试。</p>
<h4 id="MockMvc"><a href="#MockMvc" class="headerlink" title="MockMvc"></a>MockMvc</h4><p>如果我们想做一个链路测试或者模拟真实用户的请求测试以上又满足不了需求，此时我们使用<code>MockMvc</code>可以很简单的做这个事情。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WebApplicationContext wac;</span><br><span class="line"><span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mockMvc = MockMvcBuilders.webAppContextSetup(<span class="keyword">this</span>.wac).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMockMvcTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    WebSiteDTO dto = WebSiteDTO.builder()</span><br><span class="line">            .name(<span class="string">"baidu"</span>)</span><br><span class="line">            .uri(<span class="string">"https://www.baidu.com/"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    Mockito.when(webSiteRepository.add(dto)).thenReturn(<span class="number">1L</span>);</span><br><span class="line">    String url = <span class="string">"/web/add"</span>;</span><br><span class="line">    <span class="keyword">this</span>.mockMvc.perform(post(url).contentType(MediaType.APPLICATION_JSON).content(JsonUtils.toJsonString(dto)))</span><br><span class="line">            .andExpect(status().isOk()).andExpect(content().contentType(MediaType.APPLICATION_JSON))</span><br><span class="line">            .andExpect(content().json(<span class="string">"&#123;\n"</span> +</span><br><span class="line">                    <span class="string">"    \"code\": 200,\n"</span> +</span><br><span class="line">                    <span class="string">"    \"message\": \"OK\",\n"</span> +</span><br><span class="line">                    <span class="string">"    \"data\": 1\n"</span> +</span><br><span class="line">                    <span class="string">"&#125;"</span>, <span class="keyword">true</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="spring-boot-starter-test"><a href="#spring-boot-starter-test" class="headerlink" title="spring-boot-starter-test"></a>spring-boot-starter-test</h4><p>写一个单元测试要依赖几个框架是不是很麻烦，不用担心，Spring已经帮我们整合好了，只需要依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testImplementation <span class="string">'org.springframework.boot:spring-boot-starter-test:&#123;version&#125;'</span></span><br></pre></td></tr></table></figure>

<p><strong>你还在为写单元测试发愁吗？</strong></p>
</div><div class="tags"><a href="/tags/java/"><i class="fa fa-tag"></i>java</a><a href="/tags/unit-test/"><i class="fa fa-tag"></i>unit test</a></div><div class="post-nav"><a class="next" href="/2021/08/20/Redisson/">Redisson</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/音乐/">音乐</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/jwt/" style="font-size: 15px;">jwt</a> <a href="/tags/music/" style="font-size: 15px;">music</a> <a href="/tags/lock/" style="font-size: 15px;">lock</a> <a href="/tags/thread/" style="font-size: 15px;">thread</a> <a href="/tags/tidb/" style="font-size: 15px;">tidb</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/u2/" style="font-size: 15px;">u2</a> <a href="/tags/rabbitmq/" style="font-size: 15px;">rabbitmq</a> <a href="/tags/websocket/" style="font-size: 15px;">websocket</a> <a href="/tags/陈无二/" style="font-size: 15px;">陈无二</a> <a href="/tags/蒸汽波/" style="font-size: 15px;">蒸汽波</a> <a href="/tags/布仁巴雅尔/" style="font-size: 15px;">布仁巴雅尔</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/tech/" style="font-size: 15px;">tech</a> <a href="/tags/management/" style="font-size: 15px;">management</a> <a href="/tags/unit-test/" style="font-size: 15px;">unit test</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/redisson/" style="font-size: 15px;">redisson</a> <a href="/tags/JPA/" style="font-size: 15px;">JPA</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/08/21/Java单元测试/">Java Unit Test</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/20/Redisson/">Redisson</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/20/Spring Data JPA/">Spring Data JPA</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/05/架构笔记/">架构笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/03/女子日常/">酷顽音乐 30%女子日常</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/22/管理小记/">管理小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/19/蒙太奇旅行/">酷顽音乐 蒙太奇旅行</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/15/Synchronized/">Synchronized关键字</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/30/ThreadLocal/">ThreadLocal</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/15/JVM/">JVM</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Freedom.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>